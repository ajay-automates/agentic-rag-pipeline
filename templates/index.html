<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic RAG Pipeline</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0a0a;color:#e0e0e0;min-height:100vh}.container{max-width:960px;margin:0 auto;padding:2rem 1.5rem}header{text-align:center;margin-bottom:2rem}header h1{font-size:2rem;font-weight:700;background:linear-gradient(135deg,#f59e0b,#ef4444);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.5rem}header p{color:#888;font-size:.95rem}.section{background:#141414;border:1px solid #222;border-radius:12px;padding:1.5rem;margin-bottom:1.5rem}.section h2{font-size:1rem;color:#f59e0b;margin-bottom:1rem}.doc-status{display:inline-block;background:#1a1a1a;border:1px solid #333;border-radius:6px;padding:.3rem .8rem;font-size:.8rem;color:#888;margin-bottom:1rem}.doc-status span{color:#f59e0b;font-weight:600}textarea{width:100%;background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:.85rem;color:#e0e0e0;font-size:.9rem;outline:none;resize:vertical;min-height:100px;margin-bottom:.75rem;font-family:inherit}textarea:focus{border-color:#f59e0b}textarea::placeholder{color:#555}.btn-row{display:flex;gap:.5rem;flex-wrap:wrap}.btn{background:linear-gradient(135deg,#d97706,#dc2626);border:none;border-radius:8px;padding:.7rem 1.2rem;color:white;font-size:.9rem;font-weight:600;cursor:pointer}.btn:hover{opacity:.9}.btn:disabled{opacity:.5;cursor:not-allowed}.btn-secondary{background:#1a1a1a;border:1px solid #333;color:#aaa}.btn-secondary:hover{border-color:#f59e0b;color:#f59e0b}.upload-area{border:2px dashed #333;border-radius:8px;padding:1.5rem;text-align:center;cursor:pointer;margin-bottom:.75rem}.upload-area:hover{border-color:#f59e0b}.upload-area input{display:none}.upload-area p{color:#666;font-size:.85rem}.query-input{display:flex;gap:.75rem;margin-bottom:.75rem}.query-input input{flex:1;background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:.85rem 1rem;color:#e0e0e0;font-size:1rem;outline:none}.query-input input:focus{border-color:#f59e0b}.query-input input::placeholder{color:#555}.loading{display:none;text-align:center;padding:2rem}.loading.active{display:block}.spinner{width:36px;height:36px;border:3px solid #222;border-top-color:#f59e0b;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto .75rem}@keyframes spin{to{transform:rotate(360deg)}}.result{display:none}.result.active{display:block}.answer-box{background:#1a1a1a;border:1px solid #222;border-radius:12px;padding:1.5rem;margin-bottom:1rem;line-height:1.7;font-size:.95rem;color:#ccc}.answer-box strong{color:#e0e0e0}.answer-box h2,.answer-box h3{color:#f59e0b;margin:1rem 0 .5rem}.trace{background:#141414;border:1px solid #222;border-radius:12px;overflow:hidden}.trace-header{padding:.75rem 1.25rem;background:#1a1a1a;border-bottom:1px solid #222;font-size:.9rem;color:#f59e0b;cursor:pointer;display:flex;justify-content:space-between}.trace-body{padding:1rem 1.25rem;display:none}.trace-body.open{display:block}.trace-step{background:#0a0a0a;border:1px solid #1a1a1a;border-radius:8px;padding:.75rem 1rem;margin-bottom:.5rem;font-size:.8rem;font-family:'SF Mono','Fira Code',monospace;color:#888}.trace-step .step-name{color:#f59e0b;font-weight:600;margin-bottom:.3rem;font-size:.85rem}.trace-step .detail{color:#666}.trace-step .detail span{color:#aaa}.metrics-row{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}.metric-card{background:#141414;border:1px solid #222;border-radius:8px;padding:.75rem 1rem;flex:1;min-width:120px;text-align:center}.metric-card .val{font-size:1.2rem;font-weight:700;color:#f59e0b}.metric-card .lbl{font-size:.7rem;color:#666;margin-top:.2rem}.grounding{display:inline-block;padding:.2rem .6rem;border-radius:4px;font-size:.75rem;font-weight:600}.grounding.pass{background:#052e16;color:#4ade80;border:1px solid #22c55e40}.grounding.fail{background:#1a0a0a;color:#f87171;border:1px solid #ef444440}.error{display:none;background:#1a0a0a;border:1px solid #4a1515;border-radius:12px;padding:1.5rem;color:#f87171;margin-bottom:1rem}.error.active{display:block}.toast{position:fixed;bottom:1.5rem;right:1.5rem;background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:.75rem 1.25rem;font-size:.85rem;color:#4ade80;display:none;z-index:100}.toast.active{display:block}footer{text-align:center;margin-top:3rem;padding-top:1.5rem;border-top:1px solid #1a1a1a;color:#555;font-size:.8rem}footer a{color:#f59e0b;text-decoration:none}@media(max-width:640px){.query-input{flex-direction:column}.metrics-row{flex-direction:column}}
    </style>
</head>
<body>
    <div class="container">
        <header><h1>Agentic RAG Pipeline</h1><p>Self-correcting retrieval with grading, query reformulation, and hallucination detection</p></header>
        <div class="section">
            <h2>1. Upload Documents</h2>
            <div class="doc-status">Chunks in store: <span id="docCount">0</span></div>
            <div class="upload-area" onclick="document.getElementById('pdfInput').click()"><input type="file" id="pdfInput" accept=".pdf" onchange="uploadPDF(this)"><p>Click to upload PDF or paste text below</p></div>
            <textarea id="textInput" placeholder="Paste document text here..."></textarea>
            <div class="btn-row"><button class="btn" onclick="uploadText()">Ingest Text</button><button class="btn btn-secondary" onclick="clearDocs()">Clear All</button></div>
        </div>
        <div class="section">
            <h2>2. Ask a Question</h2>
            <div class="query-input"><input type="text" id="question" placeholder="Ask anything about your documents..." autofocus><button class="btn" id="queryBtn" onclick="runQuery()">Ask</button></div>
            <p style="font-size:.8rem;color:#555">The agent retrieves, grades, reformulates if needed, generates, and verifies.</p>
        </div>
        <div class="loading" id="loading"><div class="spinner"></div><p>Pipeline running...</p></div>
        <div class="error" id="error"></div>
        <div class="result" id="result">
            <div class="metrics-row" id="metrics"></div>
            <div class="answer-box" id="answer"></div>
            <div class="trace"><div class="trace-header" onclick="toggleTrace()">Pipeline Trace <span id="traceToggle">&#9660;</span></div><div class="trace-body" id="traceBody"></div></div>
        </div>
        <footer><p>Built by <a href="https://github.com/ajay-automates">Ajay Kumar Reddy Nelavetla</a> &middot; Claude + ChromaDB &middot; Self-Correcting RAG</p></footer>
    </div>
    <div class="toast" id="toast"></div>
    <script>
        function showToast(m){var t=document.getElementById('toast');t.textContent=m;t.classList.add('active');setTimeout(function(){t.classList.remove('active')},3000)}
        async function uploadText(){var text=document.getElementById('textInput').value.trim();if(!text)return alert('Paste text first');var r=await fetch('/api/upload/text',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:text,source:'pasted_text'})});var d=await r.json();if(d.error)return alert(d.error);document.getElementById('docCount').textContent=d.total_docs_in_store||d.total_chunks;document.getElementById('textInput').value='';showToast('Ingested '+d.total_chunks+' chunks')}
        async function uploadPDF(i){if(!i.files[0])return;var f=new FormData();f.append('file',i.files[0]);var r=await fetch('/api/upload/pdf',{method:'POST',body:f});var d=await r.json();if(d.error)return alert(d.error);document.getElementById('docCount').textContent=d.total_docs_in_store||d.total_chunks;showToast('PDF: '+d.total_chunks+' chunks');i.value=''}
        async function clearDocs(){if(!confirm('Clear all?'))return;await fetch('/api/clear',{method:'POST'});document.getElementById('docCount').textContent='0';showToast('Cleared')}
        document.getElementById('question').addEventListener('keydown',function(e){if(e.key==='Enter')runQuery()});
        async function runQuery(){var q=document.getElementById('question').value.trim();if(!q)return;var b=document.getElementById('queryBtn');b.disabled=true;b.textContent='Running...';document.getElementById('loading').classList.add('active');document.getElementById('error').classList.remove('active');document.getElementById('result').classList.remove('active');try{var r=await fetch('/api/query',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q})});var d=await r.json();if(d.error){document.getElementById('error').textContent=d.error;document.getElementById('error').classList.add('active')}else renderResult(d)}catch(e){document.getElementById('error').textContent=e.message;document.getElementById('error').classList.add('active')}document.getElementById('loading').classList.remove('active');b.disabled=false;b.textContent='Ask'}
        function renderResult(d){var m=d.metrics;var g=m.answer_grounded;document.getElementById('metrics').innerHTML='<div class="metric-card"><div class="val">'+m.retrieval_attempts+'</div><div class="lbl">Retrieval Attempts</div></div><div class="metric-card"><div class="val">'+m.docs_used_for_answer+'</div><div class="lbl">Docs Used</div></div><div class="metric-card"><div class="val">'+(m.query_reformulated?'Yes':'No')+'</div><div class="lbl">Reformulated</div></div><div class="metric-card"><div class="val"><span class="grounding '+(g?'pass':'fail')+'">'+(g?'Grounded':'Issues')+'</span></div><div class="lbl">Hallucination Check</div></div><div class="metric-card"><div class="val">'+m.latency_seconds+'s</div><div class="lbl">Time</div></div>';document.getElementById('answer').innerHTML=md2html(d.answer);var h='';d.pipeline_trace.forEach(function(s){var det='';Object.keys(s).forEach(function(k){if(k!=='step'){var v=typeof s[k]==='object'?JSON.stringify(s[k],null,1):s[k];det+='<div class="detail">'+k+': <span>'+v+'</span></div>'}});h+='<div class="trace-step"><div class="step-name">'+s.step+'</div>'+det+'</div>'});document.getElementById('traceBody').innerHTML=h;document.getElementById('result').classList.add('active')}
        function toggleTrace(){var b=document.getElementById('traceBody');var t=document.getElementById('traceToggle');if(b.classList.contains('open')){b.classList.remove('open');t.innerHTML='&#9660;'}else{b.classList.add('open');t.innerHTML='&#9650;'}}
        function md2html(t){if(!t)return '';return t.replace(/### (.*?)$/gm,'<h3>$1</h3>').replace(/## (.*?)$/gm,'<h2>$1</h2>').replace(/# (.*?)$/gm,'<h1>$1</h1>').replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\*(.*?)\*/g,'<em>$1</em>').replace(/\[Source: (.*?)\]/g,'<code style="background:#1e293b;padding:.1rem .3rem;border-radius:3px;color:#f59e0b;font-size:.8rem">[$1]</code>').replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>')}
        fetch('/api/health').then(function(r){return r.json()}).then(function(d){document.getElementById('docCount').textContent=d.documents_in_store||0}).catch(function(){});
    </script>
</body>
</html>
